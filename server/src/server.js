require('dotenv').config();
const bcrypt = require('bcryptjs');
const app = require('./app');
const { connectDB } = require('./config/db');
const Problem = require('./models/Problem');
const User = require('./models/User');

const PORT = process.env.PORT || 5000;

// ÐÐ²Ñ‚Ð¾ÑÐ¸Ð´Ð¸Ð½Ð³ Ð‘Ð”, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ°Ð¹Ñ‚ Ð½Ðµ Ð±Ñ‹Ð» Ð¿ÑƒÑÑ‚Ð¾Ð¹
const seedDatabaseIfEmpty = async () => {
    try {
        const problemsCount = await Problem.countDocuments();

        if (problemsCount === 0) {
            const problems = [
                {
                    title: 'ÐŸÐµÑ€ÐµÐ»Ð¾Ð¼ ÐºÐ»ÑŽÑ‡Ð¸Ñ†Ñ‹ Ñƒ Ð²ÐµÐ»Ð¾ÑÐ¸Ð¿ÐµÐ´Ð¸ÑÑ‚Ð°',
                    description:
                        'ÐŸÐ°Ñ†Ð¸ÐµÐ½Ñ‚, 28 Ð»ÐµÑ‚, ÑƒÐ¿Ð°Ð» Ñ Ð²ÐµÐ»Ð¾ÑÐ¸Ð¿ÐµÐ´Ð°. Ð–Ð°Ð»Ð¾Ð±Ñ‹ Ð½Ð° Ð±Ð¾Ð»ÑŒ Ð² Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð¿Ñ€Ð°Ð²Ð¾Ð¹ ÐºÐ»ÑŽÑ‡Ð¸Ñ†Ñ‹, Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ð¹. ÐÐ° Ñ€ÐµÐ½Ñ‚Ð³ÐµÐ½Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ðµ Ð²Ð¸Ð´Ð½Ð° Ð»Ð¸Ð½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ»Ð¾Ð¼Ð° Ð² ÑÑ€ÐµÐ´Ð½ÐµÐ¹ Ñ‚Ñ€ÐµÑ‚Ð¸ ÐºÐ»ÑŽÑ‡Ð¸Ñ†Ñ‹.',
                    difficulty: 'Easy',
                    type: 'quiz',
                    options: [
                        'ÐšÐ¾Ð½ÑÐµÑ€Ð²Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ: Ð¿Ð¾Ð²ÑÐ·ÐºÐ° Ð”ÐµÐ·Ð¾ Ð½Ð° 3â€“4 Ð½ÐµÐ´ÐµÐ»Ð¸',
                        'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð°Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ Ð¸ Ð¾ÑÑ‚ÐµÐ¾ÑÐ¸Ð½Ñ‚ÐµÐ· Ð¿Ð»Ð°ÑÑ‚Ð¸Ð½Ð¾Ð¹',
                        'Ð¡ÐºÐµÐ»ÐµÑ‚Ð½Ð¾Ðµ Ð²Ñ‹Ñ‚ÑÐ¶ÐµÐ½Ð¸Ðµ',
                        'Ð˜Ð¼Ð¼Ð¾Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð³Ð¸Ð¿ÑÐ¾Ð²Ð¾Ð¹ Ð»Ð¾Ð½Ð³ÐµÑ‚Ð¾Ð¹',
                    ],
                    correctAnswer:
                        'ÐšÐ¾Ð½ÑÐµÑ€Ð²Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ: Ð¿Ð¾Ð²ÑÐ·ÐºÐ° Ð”ÐµÐ·Ð¾ Ð½Ð° 3â€“4 Ð½ÐµÐ´ÐµÐ»Ð¸',
                },
                {
                    title: 'ÐŸÐ¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´Ð½ÐµÐ¹ ÐºÑ€ÐµÑÑ‚Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð½Ð¾Ð¹ ÑÐ²ÑÐ·ÐºÐ¸',
                    description:
                        'Ð¤ÑƒÑ‚Ð±Ð¾Ð»Ð¸ÑÑ‚, 22 Ð³Ð¾Ð´Ð°, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ñ‚Ñ€Ð°Ð²Ð¼Ñƒ ÐºÐ¾Ð»ÐµÐ½Ð°. ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼: Ñ€ÐµÐ·ÐºÐ°Ñ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ð° Ð¾Ð¿Ð¾Ñ€Ð½Ð¾Ð¹ Ð½Ð¾Ð³Ðµ. ÐŸÐ¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¿ÐµÑ€ÐµÐ´Ð½ÐµÐ³Ð¾ Ð²Ñ‹Ð´Ð²Ð¸Ð¶Ð½Ð¾Ð³Ð¾ ÑÑ‰Ð¸ÐºÐ°, Ð¾Ñ‚Ñ‘Ðº ÐºÐ¾Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÑƒÑÑ‚Ð°Ð²Ð°. ÐœÐ Ð¢ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ñ€Ð°Ð·Ñ€Ñ‹Ð² ÐŸÐšÐ¡.',
                    difficulty: 'Medium',
                    type: 'text',
                    correctAnswer:
                        'ÐÑ€Ñ‚Ñ€Ð¾ÑÐºÐ¾Ð¿Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ€ÐµÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ ÐŸÐšÐ¡ Ð°ÑƒÑ‚Ð¾Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð»Ð°Ð½Ñ‚Ð°Ñ‚Ð¾Ð¼. Ð ÐµÐ°Ð±Ð¸Ð»Ð¸Ñ‚Ð°Ñ†Ð¸Ñ 6â€“9 Ð¼ÐµÑÑÑ†ÐµÐ².',
                },
                {
                    title: 'Ð¡Ñ‚Ñ€ÐµÑÑÐ¾Ð²Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ»Ð¾Ð¼ Ð¿Ð»ÑŽÑÐ½ÐµÐ²Ð¾Ð¹ ÐºÐ¾ÑÑ‚Ð¸',
                    description:
                        'Ð‘ÐµÐ³ÑƒÐ½ Ð½Ð° Ð´Ð»Ð¸Ð½Ð½Ñ‹Ðµ Ð´Ð¸ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¸, 30 Ð»ÐµÑ‚, Ð¶Ð°Ð»ÑƒÐµÑ‚ÑÑ Ð½Ð° Ð±Ð¾Ð»ÑŒ Ð² Ð¿ÐµÑ€ÐµÐ´Ð½ÐµÐ¹ Ñ‡Ð°ÑÑ‚Ð¸ ÑÑ‚Ð¾Ð¿Ñ‹ Ð¿Ð¾ÑÐ»Ðµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ñ… Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº. Ð‘Ð¾Ð»ÐµÐ·Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸ Ð¿Ð°Ð»ÑŒÐ¿Ð°Ñ†Ð¸Ð¸ II Ð¿Ð»ÑŽÑÐ½ÐµÐ²Ð¾Ð¹ ÐºÐ¾ÑÑ‚Ð¸.',
                    difficulty: 'Medium',
                    type: 'quiz',
                    options: [
                        'ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð¾ÐºÐ¾Ð¹ 6â€“8 Ð½ÐµÐ´ÐµÐ»ÑŒ, Ð³Ð¸Ð¿Ñ',
                        'Ð¡Ð½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº, Ð¾Ñ€Ñ‚Ð¾Ð¿ÐµÐ´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±ÑƒÐ²ÑŒ, Ð¿Ð¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°Ð¼ Ñ‡ÐµÑ€ÐµÐ· 4â€“6 Ð½ÐµÐ´ÐµÐ»ÑŒ',
                        'Ð¥Ð¸Ñ€ÑƒÑ€Ð³Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ„Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð²Ð¸Ð½Ñ‚Ð°Ð¼Ð¸',
                        'Ð¤Ð¸Ð·Ð¸Ð¾Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ñ Ð±ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº',
                    ],
                    correctAnswer:
                        'Ð¡Ð½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº, Ð¾Ñ€Ñ‚Ð¾Ð¿ÐµÐ´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±ÑƒÐ²ÑŒ, Ð¿Ð¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°Ð¼ Ñ‡ÐµÑ€ÐµÐ· 4â€“6 Ð½ÐµÐ´ÐµÐ»ÑŒ',
                },
                {
                    title: 'Ð Ð°Ð·Ñ€Ñ‹Ð² Ð°Ñ…Ð¸Ð»Ð»Ð¾Ð²Ð° ÑÑƒÑ…Ð¾Ð¶Ð¸Ð»Ð¸Ñ',
                    description:
                        'Ð‘Ð°ÑÐºÐµÑ‚Ð±Ð¾Ð»Ð¸ÑÑ‚, 35 Ð»ÐµÑ‚. Ð’Ð½ÐµÐ·Ð°Ð¿Ð½Ð°Ñ Ð¾ÑÑ‚Ñ€Ð°Ñ Ð±Ð¾Ð»ÑŒ Ð² Ð¾Ð±Ð»Ð°ÑÑ‚Ð¸ Ð¿ÑÑ‚ÐºÐ¸ Ð¿Ñ€Ð¸ Ð¿Ñ€Ñ‹Ð¶ÐºÐµ. ÐŸÐ¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¢Ð¾Ð¼Ð¿ÑÐ¾Ð½Ð°, Ð¿Ð°Ð»ÑŒÐ¿Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ð¹ Ð´ÐµÑ„ÐµÐºÑ‚ ÑÑƒÑ…Ð¾Ð¶Ð¸Ð»Ð¸Ñ.',
                    difficulty: 'Hard',
                    type: 'text',
                    correctAnswer:
                        'Ð¥Ð¸Ñ€ÑƒÑ€Ð³Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ (ÑˆÐ¾Ð² ÑÑƒÑ…Ð¾Ð¶Ð¸Ð»Ð¸Ñ) Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 48 Ñ‡Ð°ÑÐ¾Ð². Ð˜Ð¼Ð¼Ð¾Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð°Ñ Ñ€ÐµÐ°Ð±Ð¸Ð»Ð¸Ñ‚Ð°Ñ†Ð¸Ñ.',
                },
                {
                    title: 'Ð¡Ð¾Ñ‚Ñ€ÑÑÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð·Ð³Ð° Ñƒ Ñ…Ð¾ÐºÐºÐµÐ¸ÑÑ‚Ð°',
                    description:
                        'Ð¥Ð¾ÐºÐºÐµÐ¸ÑÑ‚, 25 Ð»ÐµÑ‚, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» ÑƒÐ´Ð°Ñ€ Ð² Ð³Ð¾Ð»Ð¾Ð²Ñƒ. Ð–Ð°Ð»Ð¾Ð±Ñ‹: Ð³Ð¾Ð»Ð¾Ð²Ð½Ð°Ñ Ð±Ð¾Ð»ÑŒ, Ñ‚Ð¾ÑˆÐ½Ð¾Ñ‚Ð°, ÑÐ²ÐµÑ‚Ð¾Ð±Ð¾ÑÐ·Ð½ÑŒ, Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸Ð¸. ÐšÐ¢ Ð±ÐµÐ· Ð¿Ð°Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ð¸.',
                    difficulty: 'Medium',
                    type: 'quiz',
                    options: [
                        'Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ðº Ð¸Ð³Ñ€Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¸ÑÑ‡ÐµÐ·Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ ÑÐ¸Ð¼Ð¿Ñ‚Ð¾Ð¼Ð¾Ð² (1â€“2 Ð´Ð½Ñ)',
                        'ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð¾ÐºÐ¾Ð¹ 7â€“10 Ð´Ð½ÐµÐ¹, Ð·Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾ÑÑ‚Ð°Ð¿Ð½Ð¾Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°Ð¼ Ð¿Ð¾ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñƒ RTP',
                        'ÐÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð°Ñ Ð³Ð¾ÑÐ¿Ð¸Ñ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Ð½ÐµÐ¹Ñ€Ð¾Ñ…Ð¸Ñ€ÑƒÑ€Ð³Ð¸ÑŽ',
                        'ÐœÐ Ð¢ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ðº Ð¸Ð³Ñ€Ðµ Ð¿Ñ€Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¾Ðº',
                    ],
                    correctAnswer:
                        'ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð¾ÐºÐ¾Ð¹ 7â€“10 Ð´Ð½ÐµÐ¹, Ð·Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾ÑÑ‚Ð°Ð¿Ð½Ð¾Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°Ð¼ Ð¿Ð¾ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñƒ RTP',
                },
            ];

            await Problem.insertMany(problems);
            console.log(`ðŸŒ± Seeded ${problems.length} demo problems`);
        }

        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð¾Ð³Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð°, ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
        const adminEmail = 'admin321@example.com';
        const existingAdmin = await User.findOne({ email: adminEmail });

        if (!existingAdmin) {
            const hashedPassword = await bcrypt.hash('admin321', 10);
            await User.create({
                username: 'admin321',
                email: adminEmail,
                password: hashedPassword,
                role: 'admin',
            });
            console.log('ðŸ‘¤ Seeded default admin user: admin321 / admin321');
        }
    } catch (err) {
        console.error('âŒ Seed error:', err.message);
    }
};

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
connectDB().then(async () => {
    await seedDatabaseIfEmpty();

    app.listen(PORT, () => {
        console.log(`Server running on port ${PORT}`);
    });
});
